@page "/userslist"
@using System.ComponentModel
@using AntDesign.TableModels
@using System.Text.Json;

<h3>CLK Personel Listesi</h3>

<div class="btn-group">
    <div class="container">
        <button class="btn btn-primary" @onclick="goCreateUserPage">Yeni Personel Oluştur</button>
    </div>
</div>
<br />
@if (usersList != null)
{
    <table class="table table-hover table-sm">
        <thead>
            <tr>
                <th scope="col">Id</th>
                <th scope="col">Adı Soyadı</th>
                <th scope="col">E-Mail Adres</th>
                <th scope="col">Oluşturulma Tarihi</th>
                <th scope="col">Durum</th>
                <th scope="col">#</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in usersList)
            {
                string spanClass = "badge badge-pill badge-" + (user.IsActive ? "success" : "danger");
                <tr>
                    <td>@user.Id</td>
                    <td>@user.FullName</td>
                    <td>@user.EMailAddress</td>
                    <td>@user.CreateDate</td>
                    <td><span class="@spanClass">@(user.IsActive?"Active":"Passive")</span></td>
                    <td>
                        <button class="btn btn-danger" @onclick="@(()=>DeleteUser(user.Id))">Sil</button>
                        <button class="btn btn-success" @onclick="(() => goUpdatePage(user.Id))">Güncelle</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<Table @ref="table"
       TItem="WeatherForecast"
       DataSource="@forecasts"
       Total="_total"
       @bind-PageIndex="_pageIndex"
       @bind-PageSize="_pageSize"
       @bind-SelectedRows="selectedRows"
       OnChange="OnChange">
    <Selection Key="@(context.Id.ToString())" />
    <Column @bind-Field="@context.Id" Sortable />
    <Column @bind-Field="@context.Date" Format="yyyy-MM-dd" Sortable />
    <Column @bind-Field="@context.TemperatureC" Sortable />
    <Column Title="Temp. (F)" Field="@context.TemperatureF" />
    <Column Title="Hot" Field="@context.Hot">
        @*<Switch @bind-Value="@context.Hot"></Switch>*@
    </Column>
    <Column @bind-Field="@context.Summary" Sortable />
    <ActionColumn>
        <Space>
            @*<SpaceItem><Button Danger OnClick="()=>Delete(context.Id)">Delete</Button></SpaceItem>*@
        </Space>
    </ActionColumn>
</Table>
<br />
<p>PageIndex: @_pageIndex | PageSize: @_pageSize | Total: @_total</p>

@code {
    [Inject] public HttpClient HttpClient { get; set; }

    [Inject] public IUserService userService { get; set; }

    [Inject] NavigationManager navigationManager { get; set; }

    public List<UserDto> usersList = new List<UserDto>();

    WeatherForecast[] forecasts;

    IEnumerable<WeatherForecast> selectedRows;
    ITable table;

    int _pageIndex = 1;
    int _pageSize = 10;
    int _total = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadList();

        forecasts = await GetForecastAsync(_pageIndex, _pageSize);
        _total = 50;
    }
    protected void goCreateUserPage()
    {
        navigationManager.NavigateTo("/users/add");
    }
    protected void goUpdatePage(int userId)
    {
        navigationManager.NavigateTo($"/users/edit/{userId}");
    }
    protected async Task LoadList()
    {
        usersList = (await userService.GetAllUsers()).ToList();

    }
    protected async Task DeleteUser(int Id)
    {

        await userService.DeleteUserById(Id);
        await LoadList();
    }

    public class WeatherForecast
    {
        public int Id { get; set; }

        [DisplayName("Date")]
        public DateTime? Date { get; set; }

        [DisplayName("Temp. (C)")]
        public int TemperatureC { get; set; }

        [DisplayName("Summary")]
        public string Summary { get; set; }

        public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);

        public bool Hot { get; set; }
    }

    private static readonly string[] Summaries = new[]
 {
        "Freezing", "Bracing", "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot", "Sweltering", "Scorching"
    };

    public async Task OnChange(QueryModel<WeatherForecast> queryModel)
    {
        forecasts = await GetForecastAsync(queryModel.PageIndex, queryModel.PageSize);
        _total = 50;
        Console.WriteLine(JsonSerializer.Serialize(queryModel));
    }

    public Task<WeatherForecast[]> GetForecastAsync(int pageIndex, int pageSize)
    {
        var rng = new Random();
        return Task.FromResult(Enumerable.Range((pageIndex - 1) * pageSize + 1, pageSize).Select(index =>
        {
            var temperatureC = rng.Next(-20, 55);
            return new WeatherForecast
            {
                Id = index,
                Date = DateTime.Now.AddDays(index),
                TemperatureC = temperatureC,
                Summary = Summaries[rng.Next(Summaries.Length)],
                Hot = temperatureC > 30,
            };
        }).ToArray());
    }

    public void RemoveSelection(int id)
    {
        var selected = selectedRows.Where(x => x.Id != id);
        selectedRows = selected;
    }

    private void Delete(int id)
    {
        forecasts = forecasts.Where(x => x.Id != id).ToArray();
        _total = forecasts.Length;
    }
}
